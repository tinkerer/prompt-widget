services:
  pw-server:
    build:
      context: ../..
      dockerfile: packages/harness/Dockerfile
    container_name: pw-server
    ports:
      - "${SERVER_PORT:-3001}:3001"
    volumes:
      - pw-data:/data
    environment:
      - PORT=3001
      - DB_PATH=/data/prompt-widget.db
      - HARNESS_MODE=true
      - HARNESS_ID=${HARNESS_ID:-docker-harness}
      - HARNESS_NAME=${HARNESS_NAME:-Docker Harness}
      - TARGET_APP_URL=${TARGET_APP_URL:-http://pw-app:80}
      - BROWSER_MCP_URL=${BROWSER_MCP_URL:-http://pw-browser:8931/mcp}
      - APP_IMAGE=${APP_IMAGE:-}
      - APP_PORT=${APP_PORT:-8080}
    networks:
      - pw-net
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3001/api/v1/health').then(r=>{if(!r.ok)throw 1})"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

  pw-browser:
    image: mcr.microsoft.com/playwright/mcp
    container_name: pw-browser
    entrypoint: ["node", "cli.js"]
    command:
      - "--headless"
      - "--browser"
      - "chromium"
      - "--no-sandbox"
      - "--port"
      - "8931"
      - "--host"
      - "0.0.0.0"
      - "--init-script"
      - "/scripts/init-script.js"
      - "--save-trace"
    ports:
      - "${BROWSER_MCP_PORT:-8931}:8931"
    volumes:
      - ./scripts/init-script.js:/scripts/init-script.js:ro
      - ./artifacts:/tmp/playwright-output
    environment:
      - PW_SERVER_URL=${PW_SERVER_URL:-http://pw-server:3001}
      - PW_APP_KEY=${PW_APP_KEY:-}
    depends_on:
      pw-server:
        condition: service_healthy
    networks:
      - pw-net

  pw-app:
    image: ${APP_IMAGE:-nginx:alpine}
    container_name: pw-app
    ports:
      - "${APP_PORT:-8080}:${APP_INTERNAL_PORT:-80}"
    networks:
      - pw-net
    profiles:
      - app

networks:
  pw-net:
    driver: bridge

volumes:
  pw-data:
