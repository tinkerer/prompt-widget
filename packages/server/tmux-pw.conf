# tmux configuration for prompt-widget browser PTY sessions
# Inherits user's global config; these overrides improve browser terminal compat.

set -g mouse on
setw -g mode-keys vi

# Mouse drag auto-enters copy mode and starts selection
bind-key -T root MouseDrag1Pane if-shell -F -t = "#{mouse_any_flag}" "send-keys -M" "copy-mode -t=; send-keys -X begin-selection"

# Keep text highlighted after mouse release (don't exit copy mode)
bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-selection-no-clear
bind-key -T copy-mode-vi y send-keys -X copy-pipe-no-clear "pbcopy"

# Vi copy-mode bindings
bind-key -T copy-mode-vi v send -X begin-selection
bind-key -T copy-mode-vi Space send -X begin-selection
bind-key -T copy-mode-vi Escape send -X cancel
bind-key -T copy-mode-vi C-v send -X rectangle-toggle
bind-key -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel "pbcopy"

# Right-click menu in copy mode (copy/paste operations)
bind-key -T copy-mode-vi MouseDown3Pane display-menu -T "Copy Mode" -t = -x M -y M \
    "Copy Selection" c { send-keys -X copy-pipe-no-clear "pbcopy" } \
    "Copy & Exit" C { send-keys -X copy-pipe-and-cancel "pbcopy" } \
    "Cancel Selection" q { send-keys -X clear-selection } \
    '' \
    "Exit Copy Mode" Escape { send-keys -X cancel }

# Right-click menu in normal mode
bind-key -T root MouseDown3Pane {
    select-pane -t =
    display-menu -O -T "#[align=centre]#{pane_index} (#{pane_id})" -t = -x M -y M \
        "#{?#{m/r:(copy|view)-mode,#{pane_mode}},Go To Top,}" < { send-keys -X history-top } \
        "#{?#{m/r:(copy|view)-mode,#{pane_mode}},Go To Bottom,}" > { send-keys -X history-bottom } \
        '' \
        "#{?mouse_word,Search For #[underscore]#{=/9/...:mouse_word},}" C-r { if-shell -F "#{?#{m/r:(copy|view)-mode,#{pane_mode}},0,1}" "copy-mode -t=" ; send-keys -X -t = search-backward "#{q:mouse_word}" } \
        "#{?mouse_word,Type #[underscore]#{=/9/...:mouse_word},}" C-y { copy-mode -q ; send-keys -l "#{q:mouse_word}" } \
        "#{?mouse_word,Copy #[underscore]#{=/9/...:mouse_word},}" c { copy-mode -q ; set-buffer "#{q:mouse_word}" } \
        "#{?mouse_line,Copy Line,}" l { copy-mode -q ; set-buffer "#{q:mouse_line}" } \
        '' \
        "Horizontal Split" h { split-window -h } \
        "Vertical Split" v { split-window -v } \
        '' \
        "Open in Terminal" o { run-shell "osascript -e 'tell application \"Terminal\"' -e 'do script \"tmux -L prompt-widget attach-session -t #{session_name}\"' -e 'end tell'" } \
        '' \
        Kill X { kill-pane } \
        Respawn R { respawn-pane -k }
}

# Disable status bar for embedded terminals
set -g status off
